<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EliteMUD Equipment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0b0f14; --panel:#0f151d; --card:#101720; --muted:#8aa0b3; --text:#e6eef6;
      --accent:#6fb1ff; --chip:#1b2530; --line:#1a2330;
      --good:#35c759; --neutral:#ffcc00; --evil:#ff453a;
    }
    html,body {margin:0; padding:0; background:var(--bg); color:var(--text); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    .container {max-width:1200px; margin:auto; padding:20px;}
    h1 {margin:0 0 12px; font-size:28px;}
    .muted {color:var(--muted);}
    .filters {
      background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:12px; margin-bottom:16px;
      display:grid; gap:12px; grid-template-columns: repeat(auto-fill,minmax(250px,1fr));
    }
    .fgroup {display:flex; flex-direction:column; gap:6px;}
    .frow {display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .frow input[type="number"] {width:100px;}
    .sel, .txt, .num, .chk, button {
      background:var(--card); color:var(--text); border:1px solid var(--line); border-radius:10px; padding:8px 10px; font-size:14px;
    }
    .sel {width:100%;}
    button {cursor:pointer}
    .grid {display:grid; grid-template-columns: repeat(auto-fill,minmax(320px,1fr)); gap:16px;}
    .card {background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px;}
    .heading {display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .name {font-weight:700; font-size:18px;}
    .small {font-size:13px; color:var(--muted);}
    .chips {display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;}
    .chip {background:var(--chip); border:1px solid var(--line); border-radius:999px; padding:3px 10px; font-size:12px; color:var(--muted);}
    .chip.good {color:var(--good); border-color:rgba(53,199,89,.25);}
    .chip.neutral {color:var(--neutral); border-color:rgba(255,204,0,.25);}
    .chip.evil {color:var(--evil); border-color:rgba(255,69,58,.25);}
    .kv {display:grid; grid-template-columns: 1fr 1fr; gap:10px 14px; margin-top:8px;}
    .kv div {background:transparent; border:1px dashed var(--line); border-radius:10px; padding:8px;}
    .kv b {display:block; font-size:12px; color:var(--muted); margin-bottom:2px;}
    .section {margin-top:10px; border-top:1px solid var(--line); padding-top:10px;}
    .mono {font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .footer {margin-top:6px; font-size:12px; color:var(--muted);}
    .pill {display:inline-block; padding:2px 8px; border-radius:999px; background:var(--chip); color:var(--muted); font-size:12px; border:1px solid var(--line);}
    .count {margin:8px 0 12px; color:var(--muted);}
    .row {display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
  </style>
</head>
<body>
  <div class="container">
    <h1>EliteMUD Equipment</h1>

    <!-- FILTERS -->
    <div class="filters" id="filters">
      <div class="fgroup">
        <label class="small">Has stat</label>
        <select class="sel" id="hasStat">
          <option value="">(any)</option>
          <option value="DR">Has DR</option>
          <option value="HR">Has HR</option>
          <option value="AC">Has AC</option>
          <option value="Dice">Has Dice</option>
          <option value="Attributes">Has Attributes</option>
          <option value="MagicRes">Has Magic Res</option>
          <option value="Spells">Has Spells</option>
          <option value="Specials">Has Special Effects</option>
        </select>
      </div>

      <div class="fgroup">
        <label class="small">Classes (any of)</label>
        <select class="sel" id="classMulti" multiple size="6">
          <!-- Full class list in mask order -->
          <option value="As">Assassin</option>
          <option value="Ba">Bard</option>
          <option value="Ca">Cavalier</option>
          <option value="Cl">Cleric</option>
          <option value="Dr">Druid</option>
          <option value="Il">Illusionist</option>
          <option value="Kn">Knight</option>
          <option value="Ma">Mariner</option>
          <option value="Mo">Monk</option>
          <option value="Mu">Magic User</option>
          <option value="Ni">Ninja</option>
          <option value="Pa">Paladin</option>
          <option value="Ps">Psionicist</option>
          <option value="Ra">Ranger</option>
          <option value="Th">Thief</option>
          <option value="Wa">Warrior</option>
          <option value="Wi">Wizard</option>
          <option value="il">Illusionist (alt)</option>
        </select>
      </div>

      <div class="fgroup">
        <label class="small">Effects (must have all)</label>
        <select class="sel" id="effectsMulti" multiple size="6">
          <option>flaming</option>
          <option>berzerk</option>
          <option>bless</option>
          <option>curse</option>
          <option>hide</option>
          <option>sneak</option>
          <option>backstab</option>
          <option>detect</option>
          <option>detectmagic</option>
          <option>invisibility</option>
          <option>waterbreath</option>
          <option>noinf</option>
          <option>2hand</option>
          <option>evil</option>
          <option>nodrop</option>
          <option>norent</option>
          <option>regeneration</option>
          <option>dodge</option>
          <option>fly</option>
          <option>infra</option>
          <option>light</option>
          <option>sense</option>
          <option>senselife</option>
        </select>
      </div>

      <div class="fgroup">
        <label class="small">Min Resources</label>
        <div class="frow">
          <label class="small">HP</label><input id="minHP" class="num" type="number" step="1" />
          <label class="small">MN</label><input id="minMN" class="num" type="number" step="1" />
          <label class="small">MV</label><input id="minMV" class="num" type="number" step="1" />
        </div>
      </div>

      <div class="fgroup">
        <label class="small">Sort by</label>
        <select class="sel" id="sortBy">
          <option value="lvl">Min Level, then Name</option>
          <option value="name">Name (A→Z)</option>
          <option value="dr">DR (desc)</option>
          <option value="hr">HR (desc)</option>
          <option value="ac">AC (desc)</option>
        </select>
        <div class="frow">
          <button id="resetBtn">Reset</button>
        </div>
      </div>
    </div>

    <div class="count" id="count">Loading…</div>
    <div class="grid" id="grid"></div>
  </div>

  <script>
    const DATA_URL = 'eqlist_min.json';

    // Class bit order (left->right) must match your data
    const CLASS_ORDER = ["As","Ba","Ca","Cl","Dr","Il","Kn","Ma","Mo","Mu","Ni","Pa","Ps","Ra","Th","Wa","Wi","il"];

    // ---------- helpers ----------
    const byId = id => document.getElementById(id);
    const getMulti = sel => Array.from(sel.selectedOptions).map(o => o.value);
    const hasAny = v => v != null && ((Array.isArray(v) && v.length) || (typeof v === 'object' && Object.keys(v).length) || (typeof v === 'string' && v !== ''));

    const canUse = (item, selectedClasses) => {
      if (!selectedClasses.length) return true;             // no class filter
      if (!item.Classes || item.Classes === 'All') return true;
      const bits = String(item.Classes).replace(/\s+/g,'').split('');
      // pass if ANY selected class bit is 1
      return selectedClasses.some(code => {
        const idx = CLASS_ORDER.indexOf(code);
        return idx >= 0 && bits[idx] === '1';
      });
    };

    const hasEffects = (item, required) => {
      if (!required.length) return true;
      const eff = item['Special Effects'] || {};
      // all selected effects must be present (true) or numeric (for arm/cap/age you could add specific UI later)
      return required.every(k => {
        const v = eff[k];
        return v === true || (typeof v === 'number' && v !== 0);
      });
    };

    const hasMinResources = (item, minHP, minMN, minMV) => {
      const res = item['Resources'] || {};
      const okHP = minHP === null || (typeof res.HP === 'number' && res.HP >= minHP);
      const okMN = minMN === null || (typeof res.MN === 'number' && res.MN >= minMN);
      const okMV = minMV === null || (typeof res.MV === 'number' && res.MV >= minMV);
      return okHP && okMN && okMV;
    };

    const hasStat = (item, key) => {
      if (!key) return true;
      if (key === 'Attributes') return hasAny(item.Attributes);
      if (key === 'MagicRes') return hasAny(item['Magic Res']);
      if (key === 'Spells') return Array.isArray(item.Spells) && item.Spells.length > 0;
      if (key === 'Specials') return hasAny(item['Special Effects']);
      // Combat specific
      const cs = item['Combat Stats'] || {};
      if (key in cs) {
        // presence is enough (since you pruned zeros from min JSON)
        return cs[key] !== undefined && cs[key] !== null && cs[key] !== '';
      }
      return false;
    };

    const fmtKV = (obj, labelMap={}) => {
      if (!obj || typeof obj !== 'object') return '';
      const entries = Object.entries(obj);
      if (!entries.length) return '';
      return `
        <div class="kv">
          ${entries.map(([k,v]) => {
            const label = labelMap[k] || k;
            const val = Array.isArray(v) ? v.join(', ') : (typeof v === 'object' ? JSON.stringify(v) : v);
            return `<div><b>${label}</b><div class="mono">${val}</div></div>`;
          }).join('')}
        </div>
      `;
    };

    const section = (title, html) => html ? `<div class="section"><div class="small">${title}</div>${html}</div>` : '';

    const listChips = (items, className='') => items?.length ? `<div class="chips">${items.map(x => `<span class="chip ${className}">${x}</span>`).join('')}</div>` : '';

    const renderItem = (it) => {
      const topLine = [
        it.Slot, it.Type, (typeof it.Weight === 'number' ? `Wg${it.Weight}` : null),
        it.Minimumlevel != null ? `Min Lvl ${it.Minimumlevel}` : null
      ].filter(Boolean).join(' • ');

      const alignChips = [];
      if (it['Alignment Indicators']) {
        if (it['Alignment Indicators'].Good) alignChips.push('<span class="chip good">Good</span>');
        if (it['Alignment Indicators'].Neutral) alignChips.push('<span class="chip neutral">Neutral</span>');
        if (it['Alignment Indicators'].Evil) alignChips.push('<span class="chip evil">Evil</span>');
      }

      const archObj = it['Class Archetypes'] || {};
      const archChips = Object.keys(archObj).filter(k => archObj[k]).map(k => `<span class="chip">${k}</span>`);

      const combat = it['Combat Stats'];
      let combatHTML = '';
      if (combat && typeof combat === 'object') {
        const map = { Dice:'Dice', AC:'AC', DR:'DR', HR:'HR' };
        const kvs = Object.keys(combat).map(k => `<div><b>${map[k]||k}</b><div class="mono">${combat[k]}</div></div>`).join('');
        if (kvs) combatHTML = `<div class="kv">${kvs}</div>`;
      }

      const attrMap = {Str:'Str', Dex:'Dex', Int:'Int', Wis:'Wis', Cha:'Cha', Con:'Con', Agi:'Agi'};
      const resMap  = {HP:'HP', MN:'MN', MV:'MV'};
      const mrMap   = {MR:'MR', SPo:'SPo', SPh:'SPh', SMe:'SMe', SMa:'SMa'};

      const specials = it['Special Effects'];
      let specialsHTML = '';
      if (specials && typeof specials === 'object') {
        const bools = Object.entries(specials).filter(([_,v]) => v === true).map(([k]) => k.toLowerCase());
        const nums = Object.entries(specials).filter(([_,v]) => typeof v === 'number');
        if (bools.length) specialsHTML += listChips(bools);
        if (nums.length) specialsHTML += fmtKV(Object.fromEntries(nums));
      }

      let spellsHTML = '';
      if (Array.isArray(it.Spells) && it.Spells.length) {
        spellsHTML = `<div class="chips">${it.Spells.map(s => `<span class="pill">${s.count}x ${s.name}</span>`).join('')}</div>`;
      }

      const footBits = [];
      if (it.Monster) footBits.push(`Mob: ${it.Monster}`);
      if (it.Location) footBits.push(`Zone: ${it.Location}`);
      if (it.Classes && it.Classes !== 'All') footBits.push(`Classes: ${it.Classes}`);

      return `
        <div class="card">
          <div class="heading">
            <div class="name">${it.Name || 'Unnamed item'}</div>
            ${it.ID ? `<span class="pill mono">#${it.ID}</span>` : ''}
          </div>
          ${topLine ? `<div class="small">${topLine}</div>` : ''}
          ${alignChips.length ? `<div class="chips" style="margin-top:6px;">${alignChips.join('')}</div>` : ''}
          ${archChips.length ? `<div class="chips">${archChips.join('')}</div>` : ''}

          ${section('Combat', combatHTML)}
          ${section('Attributes', fmtKV(it.Attributes, attrMap))}
          ${section('Resources', fmtKV(it['Resources'], resMap))}
          ${section('Magic Res', fmtKV(it['Magic Res'], mrMap))}
          ${section('Special Effects', specialsHTML)}
          ${section('Spells', spellsHTML)}
          ${it.Misc && it.Misc.length ? section('Misc', `<div class="small mono">${it.Misc.join(', ')}</div>`) : ''}

          ${footBits.length ? `<div class="footer">${footBits.join(' • ')}</div>` : ''}
        </div>
      `;
    };

    let ALL_ITEMS = [];

    const applyFilters = () => {
      const hasStatKey = byId('hasStat').value;
      const selectedClasses = getMulti(byId('classMulti'));
      const requiredEffects = getMulti(byId('effectsMulti')).map(x => x.toLowerCase());

      const hp = byId('minHP').value.trim(); const minHP = hp === '' ? null : Number(hp);
      const mn = byId('minMN').value.trim(); const minMN = mn === '' ? null : Number(mn);
      const mv = byId('minMV').value.trim(); const minMV = mv === '' ? null : Number(mv);

      let out = ALL_ITEMS.filter(it =>
        hasStat(it, hasStatKey) &&
        canUse(it, selectedClasses) &&
        hasEffects(it, requiredEffects) &&
        hasMinResources(it, minHP, minMN, minMV)
      );

      // sort
      const sortBy = byId('sortBy').value;
      out.sort((a,b) => {
        if (sortBy === 'name') return (a.Name||'').localeCompare(b.Name||'');
        if (sortBy === 'dr') return ((b['Combat Stats']?.DR ?? -1) - (a['Combat Stats']?.DR ?? -1));
        if (sortBy === 'hr') return ((b['Combat Stats']?.HR ?? -1) - (a['Combat Stats']?.HR ?? -1));
        if (sortBy === 'ac') return ((b['Combat Stats']?.AC ?? -1) - (a['Combat Stats']?.AC ?? -1));
        // default: lvl then name
        const al = (a.Minimumlevel ?? 999999), bl = (b.Minimumlevel ?? 999999);
        if (al !== bl) return al - bl;
        return (a.Name||'').localeCompare(b.Name||'');
      });

      byId('count').textContent = `${out.length} / ${ALL_ITEMS.length} items`;
      byId('grid').innerHTML = out.map(renderItem).join('');
    };

    (async function init(){
      const res = await fetch(DATA_URL, {cache:'no-store'});
      ALL_ITEMS = await res.json();

      // defaults for your example: show items that HAVE DR, and set classes Ra/Wi/Dr
      byId('hasStat').value = 'DR';
      ['Ra','Wi','Dr'].forEach(code => {
        const opt = Array.from(byId('classMulti').options).find(o => o.value === code);
        if (opt) opt.selected = true;
      });

      // listeners
      ['hasStat','classMulti','effectsMulti','minHP','minMN','minMV','sortBy'].forEach(id => {
        byId(id).addEventListener('input', applyFilters);
        byId(id).addEventListener('change', applyFilters);
      });

      byId('resetBtn').addEventListener('click', () => {
        byId('hasStat').value = '';
        Array.from(byId('classMulti').options).forEach(o => o.selected = false);
        Array.from(byId('effectsMulti').options).forEach(o => o.selected = false);
        ['minHP','minMN','minMV'].forEach(id => byId(id).value = '');
        byId('sortBy').value = 'lvl';
        applyFilters();
      });

      applyFilters();
    })();
  </script>
</body>
</html>
